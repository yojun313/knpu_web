import os
from pathlib import Path
import json
import re

storage_path = Path(os.path.dirname(__file__)) / ".." / "storage"

output_data = {
    "피고소인 기타사항": "(고소인과의 관계 및 피고소인의 인적사항과 연락처를 정확히 알 수 없을 경우 피고소인의 성별, 특징적 외모, 인상착의 등을 입력해줘. 기타 피고소인을 특정할 수 있는 내용을 입력하면돼)",
    "고소 취지": "(죄명 및 피고소인에 대한 처벌 의사를 포함해야해. 형식은 '고소인은 피고소인을 ~~죄로 고소하오니 처벌하여 주시기 바랍니다.'이거야.)",
    "범죄 사실": "(범죄사실은 형법 등 처벌법규에 해당하는 사실에 대하여 일시, 장소, 범행방법, 결과 등을 구체적으로 특정하여 기재해야 하며, 고소인이 알고 있는 지식과 경험, 증거에 의해 사실로 인정되는 내용을 기재해줘.\
                    (예시: 피고소인는 무직으로 별다른 수입이 없고, 20,000,000원 상당의 채무를 부담하고 있었으며, 별다른 재산이 없어 피해자로부터 돈을 빌리더라도 갚을 의사나 능력이 없습니다.\
                    그럼에도 불구하고 피고소인은 2021. 0. 0. 00:00경 ○○구 ○○로에 있는 고소인의 집에서, 고소인에게 “10,000,000원만 빌려 주면 월 3%의 이자를 지급하고, 2개월 후에 틀림없이 갚겠다”고 거짓말하였습니다.\
                    피고소인은 이와 같이 고소인을 기망하여 이에 속은 고소인으로부터 즉석에서 차용금 명목으로 10,000,000원을 교부받았습니다.)이 예시를 보고 학습해서 범죄 사실을 적으면 돼.\
                    문장은 경어체(존댓말)로 끝나야하고 자신을 가리킬 때는 '고소인'이라고 지칭해야돼. 그리고 피해 일시에서 날짜 뿐만 아니라 시간도 꼭 포함해야돼)",
    "고소 이유": "(고소이유에는 피고소인의 범행 경위 및 정황, 고소를 하게 된 동기와 사유 등 범죄사실을 뒷받침하는 내용을 간략, 명료하게 기재해야 해. 그리고 합의 여부, 처벌 의사에 따라 '범죄사실과 같이 피고소인은 사기범행을 \
                    하였습니다. 피고소인과는 합의하지 않았으며/합의하였으며, 피고소인의 처벌을 원합니다/원하지 않습니다'의 문장이 포함되어 있어야해.)",
    "증거 자료": "(증거자료를 입력해줘. 없으면 공백으로 놓으면 돼)",
    "기타": "(너가 위에서 말하지 못한 것들을 여기에 입력해줘. 없으면 공백으로 놓으면 돼)",
}

def make_query(form_data):
    query = f"""
        너는 법률 문서 자동 작성 시스템이다.
        너의 임무는 아래 입력 데이터를 바탕으로 고소장을 작성하는 것이다.

        [중요 규칙]
        - 반드시 JSON 객체만 출력한다.
        - 설명, 인사말, 안내문, 주석, 코드블록(```)을 절대 포함하지 않는다.
        - 출력은 반드시 {{ 로 시작해서 }} 로 끝나야 한다.
        - 한 줄(JSON 한 줄)로 출력한다.
        - key와 value는 모두 큰따옴표(")를 사용한다.
        - key 이름은 절대 변경하지 않는다.
        - 값이 없으면 빈 문자열("")로 둔다.
        - 변호사가 작성하는 것처럼 구체적이고 정확하게 작성한다.

        [입력 데이터]
        {form_data}

        [출력 형식(JSON 스키마)]
        {output_data}

        [작성 규칙]
        - output_data의 각 key에 대해 value의 괄호 안 지시사항을 따른다.
        - 괄호와 괄호 안 문구는 최종 출력에서 제거한다.
        - 문장은 모두 존댓말로 작성한다.
        - 자신을 지칭할 때는 반드시 "고소인"이라는 표현을 사용한다.
        - 날짜에는 반드시 시간까지 포함한다.
        - 형식에 맞는 JSON만 출력하고, 그 외 텍스트는 절대 출력하지 않는다.

        지금 바로 JSON을 출력하라.
    """.strip()

    return query
    
def safe_json_load(llm_result: str) -> dict:
    if not llm_result or not isinstance(llm_result, str):
        raise ValueError("Empty or non-string LLM response")

    text = llm_result.strip()

    # 코드 블록 제거
    text = re.sub(r"```json\s*", "", text, flags=re.IGNORECASE)
    text = re.sub(r"```", "", text)

    # 마지막 } 위치
    end = text.rfind("}")
    if end == -1:
        raise ValueError("No closing brace '}' found")

    # 마지막 } 기준으로 가장 가까운 {
    start = text.rfind("{", 0, end)
    if start == -1:
        raise ValueError("No opening brace '{' found before '}'")

    json_str = text[start:end + 1].strip()
    
    return json_str