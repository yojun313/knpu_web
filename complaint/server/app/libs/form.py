import os
from pathlib import Path
import json
import re

storage_path = Path(os.path.dirname(__file__)) / ".." / "storage"

output_data = {
    "고소 죄명": "(죄명을 그대로 입력해줘)",
    "고소인 성명": "(고소인의 이름을 입력해줘)",
    "고소인 주민등록번호": "(고소인의 주민등록번호를 입력해줘)",
    "고소인 주소": "(고소인의 주소를 입력해줘)",
    "고소인 직업": "(고소인의 직업을 입력해줘)",
    "고소인 전화": "(고소인의 전화번호를 입력해줘)",
    "고소인 이메일": "(고소인의 이메일을 입력해줘)",
    "피고소인 성명": "(피고소인의 이름을 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 주민등록번호": "(피고소인의 주민등록번호를 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 주소": "(피고소인의 주소를 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 직업": "(피고소인의 직업을 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 전화": "(피고소인의 전화번호를 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 이메일": "(피고소인의 이메일을 입력해줘. 없을 경우 공백으로 놓으면 돼)",
    "피고소인 기타사항": "(고소인과의 관계 및 피고소인의 인적사항과 연락처를 정확히 알 수 없을 경우 피고소인의 성별, 특징적 외모, 인상착의 등을 입력해줘. 기타 피고소인을 특정할 수 있는 내용을 입력하면돼)",
    "고소 취지": "(죄명 및 피고소인에 대한 처벌 의사를 포함해야해. 형식은 '고소인은 피고소인을 ~~죄로 고소하오니 처벌하여 주시기 바랍니다.'이거야.)",
    "범죄 사실": "(범죄사실은 형법 등 처벌법규에 해당하는 사실에 대하여 일시, 장소, 범행방법, 결과 등을 구체적으로 특정하여 기재해야 하며, 고소인이 알고 있는 지식과 경험, 증거에 의해 사실로 인정되는 내용을 기재해줘.\
                    (예시: 피고소인는 무직으로 별다른 수입이 없고, 20,000,000원 상당의 채무를 부담하고 있었으며, 별다른 재산이 없어 피해자로부터 돈을 빌리더라도 갚을 의사나 능력이 없습니다.\
                    그럼에도 불구하고 피고소인은 2021. 0. 0. 00:00경 ○○구 ○○로에 있는 고소인의 집에서, 고소인에게 “10,000,000원만 빌려 주면 월 3%의 이자를 지급하고, 2개월 후에 틀림없이 갚겠다”고 거짓말하였습니다.\
                    피고소인은 이와 같이 고소인을 기망하여 이에 속은 고소인으로부터 즉석에서 차용금 명목으로 10,000,000원을 교부받았습니다.)이 예시를 보고 학습해서 범죄 사실을 적으면 돼.\
                    문장은 경어체(존댓말)로 끝나야하고 자신을 가리킬 때는 '고소인'이라고 지칭해야돼. 그리고 피해 일시에서 날짜 뿐만 아니라 시간도 꼭 포함해야돼)",
    "고소 이유": "(고소이유에는 피고소인의 범행 경위 및 정황, 고소를 하게 된 동기와 사유 등 범죄사실을 뒷받침하는 내용을 간략, 명료하게 기재해야 해. 그리고 합의 여부, 처벌 의사에 따라 '범죄사실과 같이 피고소인은 사기범행을 \
                    하였습니다. 피고소인과는 합의하지 않았으며/합의하였으며, 피고소인의 처벌을 원합니다/원하지 않습니다'의 문장이 포함되어 있어야해.)",
    "증거 자료": "(증거자료를 입력해줘. 없으면 공백으로 놓으면 돼)",
    "중복 고소 여부": "(있으면 '있음', 없으면 '없음'이라고 입력해줘. 물론 따옴표는 뺴야돼. 즉 있음 또는 없음으로)",
    "관련 형사사건 수사 유무": "(있으면 '있음', 없으면 '없음'이라고 입력해줘. 물론 따옴표는 뺴야돼. 즉 있음 또는 없음으로)",
    "기타": "(너가 위에서 말하지 못한 것들을 여기에 입력해줘. 없으면 공백으로 놓으면 돼)",
    "고소일": "('~~~~년 ~~월 ~~일' 로 입력해줘. (예: 2024년 1월 20일) 예를 들면 이런 형식으로. 물론 따옴표 없이, 01월 11일 이런식으로 월의 숫자가 한자리라고 해서 앞에 0을 붙이지 마)",
    "제출 경찰서": "('~~경찰서 귀중' 으로 입력해줘. 물론 따옴표 없이)"
}

def make_query(form_data: dict) -> str:
    return f"""
        너는 대한민국 형사 고소장 작성 전문가다.

        아래 [입력 정보]를 바탕으로,
        사실에 부합하고 형사 고소장 형식에 맞는 내용을 작성하라.

        요구사항:
        - 고소인 자신을 지칭할 때는 반드시 '고소인'이라고 표현할 것
        - 문장은 모두 경어체(존댓말)로 작성할 것
        - 범죄 사실에는 반드시 일시(날짜+시간), 장소, 범행 방법, 결과를 포함할 것
        - 불필요한 설명, 안내 문구, 변명, 면책 문구를 포함하지 말 것
        - 가상의 문구, 형식적 문장 반복을 피할 것
        - 실제 수사기관에 제출 가능한 문장으로 작성할 것

        [입력 정보]
        {json.dumps(form_data, ensure_ascii=False)}
        
        [출력 스키마]
        {json.dumps(output_data, ensure_ascii=False)}
    """
    
def safe_json_load(llm_result: str) -> dict:
    if not llm_result or not isinstance(llm_result, str):
        raise ValueError("Empty or non-string LLM response")

    text = llm_result.strip()

    text = re.sub(r"```json\s*", "", text, flags=re.IGNORECASE)
    text = re.sub(r"```", "", text)

    match = re.search(r"\{.*\}", text, re.DOTALL)
    if not match:
        raise ValueError("No JSON object found in LLM response")

    json_str = match.group().strip()

    return json.loads(json_str)